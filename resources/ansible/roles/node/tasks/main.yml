---
# The `instance_private_ip` is also used in the service definition file.
- name: get the private IP for the instance
  set_fact:
    node_rpc_ip: "{{ instance_facts.instances[0].network_interfaces[0].private_ip_address }}"
  when: provider == "aws"

# The `node_rpc_ip` is also used in the service definition file.
- name: use the public IP as the RPC address on DO
  set_fact:
    node_rpc_ip: "{{ ansible_host }}"
  when: provider == "digital-ocean"

- name: download the node manager binary
  ansible.builtin.get_url:
    url: "{{ node_manager_archive_url }}"
    dest: /tmp/{{ node_manager_archive_filename }}

- name: extract the node manager binary to /usr/local/bin
  become: True
  ansible.builtin.unarchive:
    src: "/tmp/{{ node_manager_archive_filename }}"
    dest: "{{ node_manager_archive_dest_path }}"
    remote_src: True

- name: add genesis node service
  ansible.builtin.command:
    argv: "{{ command_args | reject('equalto', omit) | list }}"
  vars:
    command_args:
      - "{{ node_manager_archive_dest_path }}/safenode-manager"
      - add
      - --first
      - --port=12000
      - --rpc-port=12001
      # - "{{ ('--version=' + node_version) if node_version is defined else omit }}"
      - "{{ ('--url=' + node_archive_url) if node_archive_url is defined else omit }}"
  when: is_genesis

- name: add node services
  ansible.builtin.command:
    # The `omit` filter is used to remove the `--version` argument if the
    # `node_version` variable is not defined. If the argv would be otherwise
    # defined as '', the command would fail as it doesn't expect an empty
    # argument, so it's omitted instead.
    argv: "{{ command_args | reject('equalto', omit) | list }}"
  vars:
    command_args:
      - "{{ node_manager_archive_dest_path }}/safenode-manager"
      - add
      - "--count={{ node_instance_count }}"
      - "--peer={{ genesis_multiaddr }}"
      # - "{{ ('--version=' + node_version) if node_version is defined else omit }}"
      - "{{ ('--url=' + node_archive_url) if node_archive_url is defined else omit }}"
  when: not is_genesis

- name: start the node services
  become: True
  command: safenode-manager start
